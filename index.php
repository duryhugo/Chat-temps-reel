<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
session_start();

if (!isset($_SESSION["id"])) {
    $_SESSION["id"] = "Hugo";
}

function send_chat($nick, $chat, $files = null) {
    $filename = "chat.json";
    if (!file_exists($filename)) {
        $decode = array();
    } else {
        $fopen = fopen($filename, "r");
        if (flock($fopen, LOCK_SH)) {
            $fgets = fgets($fopen);
            flock($fopen, LOCK_UN);
        }
        fclose($fopen);
        $decode = json_decode($fgets, true);
    }

    if (!is_array($decode)) {
        $decode = array();
    }

    $new_key = count($decode);

    $chat = htmlspecialchars($chat, ENT_QUOTES, 'UTF-8');
    $date = date('d/m/Y');
    $time = date('H:i');

    $file_infos = array();
    $maxFileSize = 20 * 1024 * 1024; // 20 Mo

    $chat = nl2br($chat);

    if ($files) {
        foreach ($files['name'] as $index => $name) {
            if ($files['error'][$index] == 0) {
                if ($files['size'][$index] > $maxFileSize) {
                    // Fichier trop volumineux
                    echo json_encode(array('status' => 'error', 'message' => 'Le fichier ' . $name . ' d√©passe la taille maximale de 20 Mo.'));
                    exit;
                }

                $file_name = basename($name);
                $file_path = 'uploads/' . $file_name;
                if (move_uploaded_file($files['tmp_name'][$index], $file_path)) {
                    $file_infos[] = $file_name;
                } else {
                    error_log("File upload failed: " . print_r($files, true));
                }
            } else {
                error_log("File upload error: " . $files['error'][$index]);
            }
        }
    }

    $file_info_str = implode(', ', $file_infos);

    $format = array($nick, $chat, $date, $time, $file_info_str);
    $decode[] = $format;
    $encode = json_encode($decode);

    $fopen_w = fopen($filename, "w");
    if (flock($fopen_w, LOCK_EX)) {
        fwrite($fopen_w, $encode);
        flock($fopen_w, LOCK_UN);
    }
    fclose($fopen_w);
}

function delete_chat($id) {
    $filename = "chat.json";
    if (!file_exists($filename)) {
        return;
    }

    $fopen = fopen($filename, "r");
    if (flock($fopen, LOCK_SH)) {
        $fgets = fgets($fopen);
        flock($fopen, LOCK_UN);
    }
    fclose($fopen);
    $decode = json_decode($fgets, true);

    if (isset($decode[$id])) {
        unset($decode[$id]);
        $decode = array_values($decode); // R√©indexe le tableau pour s'assurer qu'il n'y a pas de cl√©s manquantes
        $encode = json_encode($decode);

        $fopen_w = fopen($filename, "w");
        if (flock($fopen_w, LOCK_EX)) {
            fwrite($fopen_w, $encode);
            flock($fopen_w, LOCK_UN);
        }
        fclose($fopen_w);
    }
}

function show_chat($last_id = -1) {
    $filename = "chat.json";
    if (!file_exists($filename)) {
        return json_encode(array('status' => 'no data'));
    }

    $fopen = fopen($filename, "r");
    if (flock($fopen, LOCK_SH)) {
        $fgets = fgets($fopen);
        flock($fopen, LOCK_UN);
    }
    fclose($fopen);
    $decode = json_decode($fgets, true);

    $filtered_data = array();
    foreach ($decode as $key => $value) {
        if ($key > $last_id) {
            $filtered_data[$key] = $value;
        }
    }

    return json_encode($filtered_data);
}

if ((isset($_POST["chat"]) && $_POST["chat"] != "") || (isset($_FILES['files']) && $_FILES['files']['error'][0] == 0)) {
    $nick = $_SESSION["id"];
    $chat = isset($_POST["chat"]) ? $_POST["chat"] : "";
    $files = isset($_FILES['files']) ? $_FILES['files'] : null;
    send_chat($nick, $chat, $files);
}

if (isset($_POST["delete"])) {
    $id = intval($_POST["delete"]);
    delete_chat($id);
    exit;
}

if (isset($_GET["chat"])) {
    $last_id = isset($_GET["last_id"]) ? intval($_GET["last_id"]) : -1;
    echo show_chat($last_id);
    exit;
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Chat</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <style>
.msg {
    list-style-type: none;
}

.msg .message-content {
    display: block; /* Afficher chaque message sur une ligne enti√®re */
    overflow-wrap: break-word; /* Forcer un saut √† la ligne en cas de d√©bordement horizontal */
    word-wrap: break-word; /* Fallback pour une prise en charge √©tendue */
    white-space: pre-wrap; /* Permettre au texte de passer √† la ligne en fonction de la largeur du conteneur */
    word-break: break-all; /* Forcer les mots longs √† √™tre coup√©s et √† continuer sur la ligne suivante si n√©cessaire */
}
        .msg .nick { text-shadow: 1px 2px 3px red; }
        #chat {
            height: 500px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            border: none;
            padding: 10px;
        }

        textarea {
            resize: none;
        }

        #file-input {
            display: none;
        }
        #file-name {
            margin-top: 10px;
        }

        #file-button, #emoji-button {
            margin-right: 5px;
            border: none;
        }

        .btn-primary {
            background: white;
            border: none;
        }

        .btn-primary:hover {
            background: white;
            border: none;
        }

        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .context-menu button {
            padding: 8px 12px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .context-menu button:hover {
            background-color: #f0f0f0;
        }

        .emoji-picker {
    position: absolute;
    top: 28%;
    right: 61.5%;
    width: 400px; /* Ajuste la largeur selon tes pr√©f√©rences */
    z-index: 1000; /* Assure que le menu d'√©moji est au-dessus du contenu */
    background-color: rgba(255, 255, 255, 0.9); /* Fond semi-transparent */
    border-radius: 5px; /* Ajoute des coins arrondis */
    height: 300px; /* Hauteur fixe */
    overflow-y: auto; /* Ajoute une barre de d√©filement verticale si n√©cessaire */
    display : none;
}

.emoji-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

.emoji-list span {
    cursor: pointer;
    padding: 5px;
    font-size: 20px;
}

.emoji-categories{
    display: flex;
    justify-content: center; /* Centre les √©l√©ments sur l'axe horizontal */
}

.emoji-category{
    border : none;
}

.file-entry {
    display: flex;
    align-items: center;
    margin-top: 5px;
}

.file-entry span {
    margin-left: 10px;
    cursor: pointer;
    color: red;
}

.profile-and-message {
    display: flex;
    align-items: flex-start; /* Alignez les √©l√©ments en haut */
}

.profile-circle {
    width: 35px; /* Fixez la largeur de l'√©l√©ment contenant la photo de profil */
    height: 25px; /* Fixez la hauteur de l'√©l√©ment contenant la photo de profil */
    margin-right: 8px; /* Ajustez la marge pour aligner la photo de profil avec le texte */
    margin-bottom: 35px;
}

.profile-circle img {
    border-radius: 50%; /* Pour rendre l'image ronde */
    border: 2px solid #fff; /* Bordure blanche autour de l'image */    
    width: 25px; /* Fixez une largeur absolue */
    height: 25px; /* Fixez une hauteur absolue */
}

.message-content {
    flex-grow: 1; /* Permettre au contenu du message de remplir l'espace restant */
    max-width: calc(100% - 33px); /* Ajustez la largeur du texte pour √©viter le chevauchement avec l'image */
}
    </style>
</head>
<body>
<div style="margin-top: 5px" class="container">
    <div class="row">
        <div class="col-md-12" id="chat"></div>
        <div class="col-md-12">
            <form id="input-chat" action="" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <div class="input-group">
                        <textarea class="form-control" name="chat" placeholder="Tapez un message"></textarea>
                        <span class="input-group-btn">
                            <button class="btn btn-sm btn-primary" value="Envoyer" type="submit">
                            <img src="envoie.png" alt="Attach" style="width: 18px; height: 18px;">
                            </button>
                        </span>
                        <span class="input-group-btn">
                            <button id="file-button" class="btn btn-default" type="button">
                            <img src="trombone.png" alt="Attach" style="width: 20px; height: 20px;">
                            </button>
                        </span>
                        <span class="input-group-btn">
                            <button id="emoji-button" class="btn btn-default" type="button">üòä</button>
                        </span>
                    </div>
                    <br>
                    <input type="file" id="file-input" name="files[]" multiple><br>
                </div>
            </form>
            <div id="file-name"></div>
        </div>
    </div>

    <div class="emoji-picker" id="emoji-picker">
        <!-- Boutons de cat√©gories d'emojis -->
        <div class="emoji-categories">
            <button class="emoji-category" data-category="smileys">üòä</button>
            <button class="emoji-category" data-category="hearts">‚ù§Ô∏è</button>
            <button class="emoji-category" data-category="animals">üê∂</button>
            <button class="emoji-category" data-category="foods">üçè</button>
            <button class="emoji-category" data-category="activities">‚öΩ</button>
            <button class="emoji-category" data-category="places">üöó</button>
            <button class="emoji-category" data-category="objects">üí°</button>
            <button class="emoji-category" data-category="symbols">üî£</button>
        </div>
        <!-- Emojis class√©s par cat√©gories -->
        <div class="emoji-list" id="emoji-smileys" style="display: block;">
        <span>üëã</span><span>ü§ö</span><span>üñêÔ∏è</span><span>‚úã</span><span>üññ</span><span>üëå</span><span>ü§è</span>
<span>‚úåÔ∏è</span><span>ü§û</span><span>ü§ü</span><span>ü§ò</span><span>ü§ô</span><span>üëà</span><span>üëâ</span>
<span>üëÜ</span><span>üëá</span><span>‚òùÔ∏è</span><span>üëç</span><span>üëé</span><span>‚úä</span><span>üëä</span>
<span>ü§õ</span><span>ü§ú</span><span>üëè</span><span>üôå</span><span>üëê</span><span>ü§≤</span><span>ü§ù</span>
<span>üôè</span><span>‚úçÔ∏è</span><span>üíÖ</span><span>ü§≥</span><span>üí™</span><span>üòÉ</span><span>üòÑ</span><span>üòÅ</span><span>üòÜ</span><span>üòÖ</span><span>üòÇ</span><span>ü§£</span>
            <span>üòä</span><span>üòá</span><span>üôÇ</span><span>üôÉ</span><span>üòâ</span><span>üòå</span><span>üòç</span>
            <span>üòò</span><span>üòó</span><span>üòô</span><span>üòö</span><span>üòã</span><span>üòõ</span><span>üòù</span>
            <span>üòú</span><span>ü§™</span><span>ü§®</span><span>üßê</span><span>ü§ì</span><span>üòé</span><span>ü§©</span>
            <span>üòè</span><span>üòí</span><span>üòû</span><span>üòî</span><span>üòü</span><span>üòï</span><span>üôÅ</span>
            <span>üò£</span><span>üòñ</span><span>üò´</span><span>üò©</span><span>üò§</span><span>üò†</span><span>üò°</span>
            <span>ü§¨</span><span>üòà</span><span>üëø</span><span>üíÄ</span><span>‚ò†Ô∏è</span><span>üí©</span><span>ü§°</span>
            <span>üëπ</span><span>üë∫</span><span>üëª</span><span>üëΩ</span><span>üëæ</span><span>ü§ñ</span><span>üò∫</span>
            <span>üò∏</span><span>üòπ</span><span>üòª</span><span>üòº</span><span>üòΩ</span><span>üôÄ</span><span>üòø</span>
            <span>üòæ</span><span>üôà</span><span>üôâ</span><span>üôä</span>
        </div>
        <div class="emoji-list" id="emoji-hearts" style="display: none;">
        <span>üíì</span><span>üíî</span><span>‚ù£Ô∏è</span><span>üíï</span><span>üíñ</span><span>üíó</span><span>üíò</span>
<span>üíù</span><span>üíû</span><span>üíü</span><span>‚ù§Ô∏è</span><span>üß°</span><span>üíõ</span><span>üíö</span>
<span>üíô</span><span>üíú</span><span>ü§é</span><span>üñ§</span><span>ü§ç</span>
        </div>
        <div class="emoji-list" id="emoji-animals" style="display: none;">
        <span>üê∂</span><span>üê±</span><span>üê≠</span><span>üêπ</span><span>üê∞</span><span>ü¶ä</span><span>ü¶ù</span>
<span>üêª</span><span>üêº</span><span>ü¶Ñ</span><span>üêØ</span><span>üê∏</span><span>üê∑</span><span>üêÆ</span>
<span>üêó</span><span>üêµ</span><span>üêí</span><span>ü¶ç</span><span>ü¶ß</span><span>üê∫</span><span>ü¶ä</span>
<span>ü¶ù</span><span>üê¥</span><span>ü¶ì</span><span>ü¶å</span><span>üêÉ</span><span>üêÑ</span><span>üêé</span>
<span>üêñ</span><span>üêè</span><span>üêë</span><span>üêê</span><span>ü¶ô</span><span>ü¶ò</span><span>ü¶•</span>
<span>ü¶®</span><span>ü¶°</span><span>üêï</span><span>ü¶Æ</span><span>üêï‚Äçü¶∫</span><span>üê©</span><span>üê∫</span>
<span>ü¶Æ</span><span>ü¶∫</span><span>üêà‚Äç‚¨õ</span><span>üêæ</span><span>ü¶•</span><span>ü¶¶</span><span>ü¶á</span>
<span>üêª‚Äç‚ùÑÔ∏è</span><span>üê®</span><span>üêº</span><span>ü¶•</span><span>ü¶¶</span><span>ü¶ß</span><span>ü¶®</span>
<span>ü¶ò</span><span>ü¶°</span><span>üê¶</span><span>ü¶â</span><span>ü¶¢</span><span>ü¶©</span><span>ü¶ö</span>
<span>ü¶ú</span><span>üêß</span><span>üïäÔ∏è</span><span>ü¶§</span><span>ü¶Ü</span><span>ü¶Ö</span><span>ü¶â</span>
<span>ü¶©</span><span>ü¶ö</span><span>ü¶ú</span><span>üïäÔ∏è</span><span>üêî</span><span>üêì</span><span>üê£</span>
<span>üê§</span><span>üê•</span><span>üê¶</span><span>ü¶Ö</span><span>ü¶Ü</span><span>ü¶¢</span><span>ü¶ú</span>
<span>ü¶©</span><span>ü¶ö</span><span>ü¶ú</span><span>üïäÔ∏è</span><span>üêç</span><span>üê¢</span><span>ü¶é</span>
<span>ü¶ñ</span><span>ü¶ï</span><span>üêô</span><span>ü¶ë</span><span>ü¶ê</span><span>ü¶û</span><span>ü¶Ä</span>
<span>üê°</span><span>üê†</span><span>üêü</span><span>üê¨</span><span>üê≥</span><span>üêã</span><span>ü¶à</span>
<span>üêä</span><span>üêÖ</span><span>üêÜ</span><span>ü¶ì</span><span>ü¶ç</span><span>üêò</span><span>ü¶õ</span>
<span>ü¶è</span><span>üê™</span><span>üê´</span><span>ü¶í</span><span>ü¶ò</span><span>üêÉ</span><span>üêÇ</span>
<span>üêÑ</span><span>üêé</span><span>üêñ</span><span>üêè</span><span>üêë</span><span>üêê</span><span>ü¶ô</span>
<span>ü¶å</span><span>üêï</span><span>üê©</span><span>üêà</span><span>üêì</span><span>ü¶É</span><span>ü¶ö</span>
<span>ü¶ú</span><span>ü¶¢</span><span>ü¶©</span><span>ü¶ö</span><span>ü¶ú</span><span>üïäÔ∏è</span>
    </div>
<div class="emoji-list" id="emoji-foods" style="display: none;">
        <span>üçè</span><span>üçé</span><span>üçê</span><span>üçä</span><span>üçã</span><span>üçå</span><span>üçâ</span>
            <span>üçá</span><span>üçì</span><span>üçà</span><span>üçí</span><span>üçë</span><span>üçç</span><span>ü•≠</span><span>ü••</span>
            <span>ü•¶</span><span>ü•ë</span><span>ü•ù</span><span>ü•¨</span><span>ü•í</span><span>üå∂Ô∏è</span><span>ü´ë</span><span>üåΩ</span>
            <span>ü•ï</span><span>ü´í</span><span>üçÜ</span><span>ü•î</span><span>üç†</span><span>üå∞</span><span>ü•ú</span><span>üçØ</span>
            <span>ü•ê</span><span>üçû</span><span>ü•ñ</span><span>ü´ì</span><span>ü•®</span><span>ü•Ø</span><span>ü•û</span><span>üßá</span>
            <span>üßÄ</span><span>üçñ</span><span>üçó</span><span>ü•©</span><span>ü•ì</span><span>üçî</span><span>üçü</span><span>üçï</span>
            <span>üå≠</span><span>ü•™</span><span>üåÆ</span><span>üåØ</span><span>ü´î</span><span>ü•ô</span><span>üßÜ</span><span>ü•ö</span>
            <span>üç≥</span><span>ü•ò</span><span>üç≤</span><span>ü´ï</span><span>ü•£</span><span>ü•ó</span><span>üçø</span><span>üßà</span>
            <span>üßÇ</span><span>ü•´</span><span>üç±</span><span>üçò</span><span>üçô</span><span>üçö</span><span>üçõ</span><span>üçú</span>
            <span>üçù</span><span>üç†</span><span>üç¢</span><span>üç£</span><span>üç§</span><span>üç•</span><span>ü•Æ</span><span>üç°</span>
            <span>ü•ü</span><span>ü•†</span><span>ü•°</span><span>ü¶Ä</span><span>ü¶û</span><span>ü¶ê</span><span>ü¶ë</span><span>ü¶™</span>
            <span>üç¶</span><span>üçß</span><span>üç®</span><span>üç©</span><span>üç™</span><span>üéÇ</span><span>üç∞</span><span>üßÅ</span>
            <span>ü•ß</span><span>üç´</span><span>üç¨</span><span>üç≠</span><span>üçÆ</span><span>üçØ</span><span>üçº</span><span>ü•§</span>
            <span>üßÉ</span><span>üßâ</span><span>üßä</span><span>ü•õ</span><span>üçµ</span><span>üç∂</span><span>üçæ</span><span>üç∑</span>
            <span>üç∏</span><span>üçπ</span><span>üç∫</span><span>üçª</span><span>ü•Ç</span><span>ü•É</span><span>ü•§</span><span>üßã</span>
            <span>üßä</span><span>ü•¢</span><span>üçΩÔ∏è</span><span>üç¥</span><span>ü•Ñ</span><span>üî™</span><span>üè∫</span><span>üåç</span>
    </div>
        <div class="emoji-list" id="emoji-activities" style="display: none;">
        <span>‚öΩ</span><span>üèÄ</span><span>üèà</span><span>‚öæ</span><span>üéæ</span><span>üèê</span><span>üèâ</span>
            <span>üé±</span><span>üèì</span><span>üè∏</span><span>ü•Ö</span><span>ü•ä</span><span>ü•ã</span><span>üéΩ</span><span>‚õ∑Ô∏è</span>
            <span>üèÇ</span><span>ü™Ç</span><span>üèãÔ∏è</span><span>üèãÔ∏è‚Äç‚ôÇÔ∏è</span><span>üèãÔ∏è‚Äç‚ôÄÔ∏è</span><span>ü§º</span><span>ü§º‚Äç‚ôÇÔ∏è</span>
            <span>ü§º‚Äç‚ôÄÔ∏è</span><span>ü§∏</span><span>ü§∏‚Äç‚ôÇÔ∏è</span><span>ü§∏‚Äç‚ôÄÔ∏è</span><span>‚õπÔ∏è</span><span>‚õπÔ∏è‚Äç‚ôÇÔ∏è</span>
            <span>‚õπÔ∏è‚Äç‚ôÄÔ∏è</span><span>ü§∫</span><span>ü§æ</span><span>ü§æ‚Äç‚ôÇÔ∏è</span><span>ü§æ‚Äç‚ôÄÔ∏è</span><span>üèåÔ∏è</span>
            <span>üèåÔ∏è‚Äç‚ôÇÔ∏è</span><span>üèåÔ∏è‚Äç‚ôÄÔ∏è</span><span>üèá</span><span>üßò</span><span>üßò‚Äç‚ôÇÔ∏è</span><span>üßò‚Äç‚ôÄÔ∏è</span><span>üèÑ</span><span>üèÑ‚Äç‚ôÇÔ∏è</span>
            <span>üèÑ‚Äç‚ôÄÔ∏è</span><span>üèä</span><span>üèä‚Äç‚ôÇÔ∏è</span><span>üèä‚Äç‚ôÄÔ∏è</span><span>‚õπÔ∏è</span><span>‚õπÔ∏è‚Äç‚ôÇÔ∏è</span>
            <span>‚õπÔ∏è‚Äç‚ôÄÔ∏è</span><span>üèãÔ∏è</span><span>üèãÔ∏è‚Äç‚ôÇÔ∏è</span><span>üèãÔ∏è‚Äç‚ôÄÔ∏è</span><span>üö¥</span><span>üö¥‚Äç‚ôÇÔ∏è</span>
            <span>üö¥‚Äç‚ôÄÔ∏è</span><span>üöµ</span><span>üöµ‚Äç‚ôÇÔ∏è</span><span>üöµ‚Äç‚ôÄÔ∏è</span><span>ü§π</span><span>ü§π‚Äç‚ôÇÔ∏è</span>
            <span>ü§π‚Äç‚ôÄÔ∏è</span><span>ü§æ</span><span>ü§æ‚Äç‚ôÇÔ∏è</span><span>ü§æ‚Äç‚ôÄÔ∏è</span><span>üßó</span><span>üßó‚Äç‚ôÇÔ∏è</span>
            <span>üßó‚Äç‚ôÄÔ∏è</span><span>üö£</span><span>üö£‚Äç‚ôÇÔ∏è</span><span>üö£‚Äç‚ôÄÔ∏è</span><span>üßò</span><span>üßò‚Äç‚ôÇÔ∏è</span>
            <span>üßò‚Äç‚ôÄÔ∏è</span><span>üõÄ</span><span>üõå</span><span>üßë‚Äçü§ù‚Äçüßë</span><span>üë´</span><span>üë¨</span>
            <span>üë≠</span><span>üíè</span><span>üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®</span><span>üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®</span><span>üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë©</span>
            <span>üíë</span><span>üë©‚Äç‚ù§Ô∏è‚Äçüë®</span><span>üë®‚Äç‚ù§Ô∏è‚Äçüë®</span><span>üë©‚Äç‚ù§Ô∏è‚Äçüë©</span><span>üë™</span><span>üë®‚Äçüë©‚Äçüë¶</span>
            <span>üë®‚Äçüë©‚Äçüëß</span><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span><span>üë®‚Äçüë©‚Äçüë¶‚Äçüë¶</span><span>üë®‚Äçüë©‚Äçüëß‚Äçüëß</span><span>üë©‚Äçüë©‚Äçüë¶</span>
            <span>üë©‚Äçüë©‚Äçüëß</span><span>üë©‚Äçüë©‚Äçüëß‚Äçüë¶</span><span>üë©‚Äçüë©‚Äçüë¶‚Äçüë¶</span><span>üë©‚Äçüë©‚Äçüëß‚Äçüëß</span><span>üë®‚Äçüë®‚Äçüë¶</span>
            <span>üë®‚Äçüë®‚Äçüëß</span><span>üë®‚Äçüë®‚Äçüëß‚Äçüë¶</span><span>üë®‚Äçüë®‚Äçüë¶‚Äçüë¶</span><span>üë®‚Äçüë®‚Äçüëß‚Äçüëß</span><span>üë©‚Äçüë¶</span>
            <span>üë©‚Äçüëß</span><span>üë©‚Äçüëß‚Äçüë¶</span><span>üë©‚Äçüë¶‚Äçüë¶</span><span>üë©‚Äçüëß‚Äçüëß</span><span>üë®‚Äçüë¶</span><span>üë®‚Äçüëß</span>
            <span>üë®‚Äçüëß‚Äçüë¶</span><span>üë®‚Äçüë¶‚Äçüë¶</span><span>üë®‚Äçüëß‚Äçüëß</span><span>üëö</span><span>üëï</span><span>ü•º</span>
            <span>ü¶∫</span><span>üëî</span><span>üëó</span><span>ü©±</span><span>üëñ</span><span>ü©≤</span><span>ü©≥</span>
            <span>üëò</span><span>ü•ª</span><span>ü©¥</span><span>ü•ø</span><span>üë†</span><span>üë°</span><span>üë¢</span>
            <span>üëû</span><span>üëü</span><span>ü•æ</span><span>üß¶</span><span>üß§</span><span>üß£</span><span>üé©</span>
            <span>üß¢</span><span>üëí</span><span>üéì</span><span>‚õëÔ∏è</span><span>ü™ñ</span><span>üíº</span><span>üß≥</span>
            <span>üëú</span><span>üëù</span><span>üõçÔ∏è</span><span>üéí</span><span>üëë</span><span>üß¢</span><span>üìø</span>
            <span>üíÑ</span><span>üíç</span><span>üíé</span><span>üîá</span><span>üîà</span><span>üîâ</span><span>üîä</span>
        </div>
        <div class="emoji-list" id="emoji-places" style="display: none;">
        <span>üöó</span><span>üöï</span><span>üöô</span><span>üöå</span><span>üöé</span><span>üèéÔ∏è</span><span>üöì</span>
<span>üöë</span><span>üöí</span><span>üöê</span><span>üöö</span><span>üöõ</span><span>üöú</span><span>üõ¥</span><span>üö≤</span>
<span>üõµ</span><span>üèçÔ∏è</span><span>üö®</span><span>üöî</span><span>üöç</span><span>üöò</span><span>üöñ</span><span>üö°</span>
<span>üö†</span><span>üöü</span><span>üöÉ</span><span>üöã</span><span>üöû</span><span>üöù</span><span>üöÑ</span><span>üöÖ</span>
<span>üöà</span><span>üöÇ</span><span>üöÜ</span><span>üöá</span><span>üöä</span><span>üöâ</span><span>üöÅ</span><span>üõ©Ô∏è</span>
<span>‚úàÔ∏è</span><span>üõ´</span><span>üõ¨</span><span>ü™Ç</span><span>üöÄ</span><span>üõ∏</span><span>üõ∂</span><span>‚õµ</span>
<span>üö§</span><span>üõ•Ô∏è</span><span>üö¢</span><span>‚õ¥Ô∏è</span><span>üöÅ</span><span>üöü</span><span>üö°</span><span>üö≤</span>
        </div>
        <div class="emoji-list" id="emoji-objects" style="display: none;">
        <span>üí°</span><span>üî¶</span><span>üïØÔ∏è</span><span>üõ¢Ô∏è</span><span>üîë</span><span>üî®</span><span>üö™</span>
<span>üõèÔ∏è</span><span>üõãÔ∏è</span><span>üöΩ</span><span>üöø</span><span>üõÅ</span><span>üß¥</span><span>üßΩ</span><span>üßª</span>
<span>üè†</span><span>üè°</span><span>üè¢</span><span>üè£</span><span>üè§</span><span>üè•</span><span>üè¶</span><span>üè®</span>
<span>üè©</span><span>üè™</span><span>üè´</span><span>üè¨</span><span>üè≠</span><span>üèØ</span><span>üè∞</span><span>üíí</span>
<span>üóº</span><span>üóΩ</span><span>‚õ™</span><span>üïå</span><span>üõï</span><span>üïç</span><span>‚õ©Ô∏è</span><span>üïã</span>
<span>‚õ≤</span><span>‚õ∫</span><span>üåÅ</span><span>üåÉ</span><span>üèôÔ∏è</span><span>üåÑ</span><span>üåÖ</span><span>üåÜ</span>
<span>üåá</span><span>üåâ</span><span>üåå</span><span>üé†</span><span>üé°</span><span>üé¢</span><span>üíà</span><span>üé™</span>
<span>üöÇ</span><span>üöÉ</span><span>üöÑ</span><span>üöÖ</span><span>üöÜ</span><span>üöá</span><span>üöà</span><span>üöâ</span>
<span>üöä</span><span>üöù</span><span>üöû</span><span>üöã</span><span>üöå</span><span>üöç</span><span>üöé</span><span>üöê</span>
<span>üöë</span><span>üöí</span><span>üöì</span><span>üöî</span><span>üöï</span><span>üöñ</span><span>üöó</span><span>üöò</span>
<span>üöö</span><span>üöõ</span><span>üöú</span><span>üõ¥</span><span>üõµ</span><span>üö≤</span><span>üõµ</span><span>üõ¥</span>
<span>üöè</span><span>üõ§Ô∏è</span><span>üõ£Ô∏è</span><span>üõ¢Ô∏è</span><span>‚õΩ</span><span>üö®</span><span>üö•</span><span>üö¶</span>
<span>üõë</span><span>üöß</span><span>‚öì</span><span>‚õµ</span><span>üõ∂</span><span>üö§</span><span>üõ≥Ô∏è</span><span>‚õ¥Ô∏è</span>
<span>üõ•Ô∏è</span><span>‚úàÔ∏è</span><span>üõ©Ô∏è</span><span>üõ´</span><span>üõ¨</span><span>ü™Ç</span><span>üí∫</span><span>üöÅ</span>
<span>üöü</span><span>üö°</span><span>üö†</span><span>üõ∞Ô∏è</span><span>üöÄ</span><span>üõ∏</span><span>üå†</span><span>üåå</span>
<span>‚õ∫</span><span>üè†</span><span>üè°</span><span>üè¢</span><span>üè£</span><span>üè§</span><span>üè•</span><span>üè¶</span>
<span>üè®</span><span>üè©</span><span>üè™</span><span>üè´</span><span>üè¨</span><span>üè≠</span><span>üèØ</span><span>üè∞</span>
<span>üíí</span><span>üóº</span><span>üóΩ</span><span>üïã</span><span>‚õ™</span><span>üïå</span><span>üõï</span><span>üïç</span>
<span>üèüÔ∏è</span><span>üèõÔ∏è</span><span>üèóÔ∏è</span><span>üß±</span><span>ü™®</span><span>üî©</span><span>‚öôÔ∏è</span><span>‚õìÔ∏è</span>
<span>üß∞</span><span>üî®</span><span>ü™ö</span><span>ü™õ</span><span>üîß</span><span>üî©</span><span>‚öíÔ∏è</span><span>üõ†Ô∏è</span>
<span>‚õèÔ∏è</span><span>ü™ì</span><span>üî™</span><span>üó°Ô∏è</span><span>‚öîÔ∏è</span><span>üõ°Ô∏è</span><span>üö™</span><span>üõèÔ∏è</span>
<span>üõãÔ∏è</span><span>ü™ë</span><span>üöΩ</span><span>üöø</span><span>üõÅ</span><span>ü™í</span><span>üß¥</span><span>üßΩ</span>
<span>üßª</span><span>üßº</span><span>üõéÔ∏è</span><span>üîë</span><span>üóùÔ∏è</span><span>üö™</span><span>üõãÔ∏è</span><span>üîí</span>
<span>üîì</span><span>üîè</span><span>üîê</span>
        </div>
        <div class="emoji-list" id="emoji-symbols" style="display: none;">
        <span>üî£</span><span>üéå</span><span>üè¥</span><span>üö©</span><span>üíØ</span><span>üî¢</span>
            <span>üÜó</span><span>üî†</span><span>üî°</span><span>üî§</span><span>‚ÜóÔ∏è</span><span>‚ÜòÔ∏è</span><span>‚ÜôÔ∏è</span><span>‚ÜñÔ∏è</span>
        </div>
    </div>

    <div class="context-menu" id="context-menu">
    <button id="delete-message">Supprimer le message</button>
    <button id="edit-message">Modifier le message</button>
    <button id="reply-message">R√©pondre</button>
    <button id="react-message">Ajouter une r√©action</button>
</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastId = -1;
    let isScrolledToBottom = true;
    let userSentMessage = false;
    let messageToDelete = null;

    const chatDiv = document.getElementById('chat');
    const contextMenu = document.getElementById('context-menu');
    const deleteButton = document.getElementById('delete-message');
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    const textarea = document.querySelector('textarea[name="chat"]');
    const form = document.getElementById('input-chat');

    chatDiv.addEventListener('scroll', function() {
        isScrolledToBottom = chatDiv.scrollHeight - chatDiv.scrollTop === chatDiv.clientHeight;
    });

    document.getElementById('file-button').addEventListener('click', function() {
        document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', function() {
    const fileInput = document.getElementById('file-input');
    const fileNameDiv = document.getElementById('file-name');
    const files = fileInput.files;
    const maxFileSize = 20 * 1024 * 1024; // 20 Mo

    fileNameDiv.innerHTML = '';
    let fileTooLarge = false;

    for (let i = 0; i < files.length; i++) {
        if (files[i].size > maxFileSize) {
            fileTooLarge = true;
            break;
        }

        const fileEntry = document.createElement('div');
        fileEntry.classList.add('file-entry');
        fileEntry.innerHTML = `${files[i].name} <span data-index="${i}">‚úñ</span>`;
        fileNameDiv.appendChild(fileEntry);

        fileEntry.querySelector('span').addEventListener('click', function() {
            removeFile(i);
        });
    }

    if (fileTooLarge) {
        alert('Un ou plusieurs fichiers d√©passent la taille maximale de 20 Mo.');
        fileInput.value = ''; // Reset file input
        fileNameDiv.innerHTML = ''; // Clear file names
    }
});

    textarea.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            form.dispatchEvent(new Event('submit', { cancelable: true }));
        }
    });

    chatDiv.addEventListener('contextmenu', function(event) {
        event.preventDefault();
        const target = event.target.closest('.msg');
        if (target) {
            messageToDelete = target;
            contextMenu.style.top = `${event.clientY}px`;
            contextMenu.style.left = `${event.clientX}px`;
            contextMenu.style.display = 'block';
        }
    });

    document.addEventListener('click', function() {
        contextMenu.style.display = 'none';
    });

    deleteButton.addEventListener('click', async function() {
        if (messageToDelete) {
            const messageId = messageToDelete.dataset.id;
            await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `delete=${messageId}`
            });
            messageToDelete.remove(); // Supprime l'√©l√©ment .msg complet
            messageToDelete = null;
        }
    });

    document.querySelectorAll('.emoji-category').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.emoji-list').forEach(list => list.style.display = 'none');
            const category = this.dataset.category;
            document.getElementById(`emoji-${category}`).style.display = 'block';
        });
    });

    emojiPicker.addEventListener('click', function(event) {
        if (event.target.tagName === 'SPAN') {
            textarea.value += event.target.textContent;
            emojiPicker.style.display = 'none';
        }
    });

    emojiButton.addEventListener('click', function() {
        emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    });

    async function fetchChat() {
        try {
            const response = await fetch(`?chat=1&last_id=${lastId}`);
            const data = await response.json();
            if (data.status !== 'no data') {
                Object.keys(data).forEach(key => {
                    const post = data[key];
                    const row = document.createElement('div');
                    row.classList.add('msg');
                    row.dataset.id = key;

                    let message = `<div class="profile-and-message">`;
                    if (post[0] === 'Hugo') {
                        message += `<div class="profile-circle">`;
                        message += `<img src="avatars/kaaris.jpg" alt="Photo de profil de Hugo">`;
                        message += `</div>`;
                    }
                    message += `<div class="message-content">`;
                    message += `<b>${post[0]}</b> `;
                    message += `<span style="color:gray; font-size:smaller;">${post[2]}</span> `;
                    message += `<span style="color:gray; font-size:smaller;">${post[3]}</span><br>`;
                    if (post[1] != "") {
                        message += `${post[1]}<br><br>`;
                    }
                    if (post[4]) {
                        const files = post[4].split(',').map(file => file.trim());
                        files.forEach(file => {
                            message += `<a href="uploads/${file}" download>${file}</a><br>`;
                        });
                    }
                    message += `</div>`;
                    message += `</div>`;
                    row.innerHTML = message;
                    chatDiv.appendChild(row);
                    lastId = key;
                });
            }
            if (isScrolledToBottom || userSentMessage) {
                chatDiv.scrollTop = chatDiv.scrollHeight;
                userSentMessage = false;
            }
        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration des messages:', error);
        }
    }

    form.addEventListener('submit', async function(event) {
    const fileInput = document.getElementById('file-input');
    const files = fileInput.files;
    const maxFileSize = 20 * 1024 * 1024; // 20 Mo
    let fileTooLarge = false;

    for (let i = 0; i < files.length; i++) {
        if (files[i].size > maxFileSize) {
            fileTooLarge = true;
            break;
        }
    }

    if (fileTooLarge) {
        alert('Un ou plusieurs fichiers d√©passent la taille maximale de 20 Mo.');
        event.preventDefault();
        return;
    }

    event.preventDefault();
    const formData = new FormData(form);
    try {
        await fetch('', {
            method: 'POST',
            body: formData
        });
        form.reset();
        document.getElementById('file-name').textContent = '';
        userSentMessage = true;
    } catch (error) {
        console.error('Erreur lors de l\'envoi du message:', error);
    }
});

    function removeFile(index) {
        const fileInput = document.getElementById('file-input');
        const dataTransfer = new DataTransfer();

        const files = fileInput.files;

        for (let i = 0; i < files.length; i++) {
            if (i !== index) {
                dataTransfer.items.add(files[i]);
            }
        }

        fileInput.files = dataTransfer.files;

        // Mettre √† jour la vue des fichiers
        const fileNameDiv = document.getElementById('file-name');
        fileNameDiv.innerHTML = '';

        for (let i = 0; i < fileInput.files.length; i++) {
            const fileEntry = document.createElement('div');
            fileEntry.classList.add('file-entry');
            fileEntry.innerHTML = `${fileInput.files[i].name} <span data-index="${i}">‚úñ</span>`;
            fileNameDiv.appendChild(fileEntry);

            fileEntry.querySelector('span').addEventListener('click', function() {
                removeFile(i);
            });
        }
    }

    fetchChat();
    setInterval(fetchChat, 2000);
});

</script>
</body>
</html>